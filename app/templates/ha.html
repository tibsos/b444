{% load static %}
{% load compress %}

<!DOCTYPE html>

<html>

    <head>

                <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-EG2SLVG8BT"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-EG2SLVG8BT');
        </script>

        <!-- Yandex.Metrika counter -->
        <script type="text/javascript" >
            (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
            (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        
            ym(96442202, "init", {
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true,
                webvisor:true
            });
        </script>
        <noscript><div><img src="https://mc.yandex.ru/watch/96442202" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
        <!-- /Yandex.Metrika counter -->
        
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Мой блокнотик</title>

        <link rel="icon" type="image/x-icon" href="{% static 'logo.png' %}">

        <script src="{% static 'packages/jquery-3.6.1.min.js' %}"></script>
        <script src="{% static 'packages/htmx.min.js' %}"></script>
        <script src="{% static 'packages/iconify.min.js' %}"></script>

        {% compress css %}

            <link rel="stylesheet" href="{% static 'scss/app/home_mobile.scss' %}" type="text/x-scss">

        {% endcompress %}

    </head>
    
    <body>

        <div class="everything">

            <!-- TopNav -->
            <div class="topnav">

                <div class="topnav-wrapper">

                    <div class="toggle-sidenav">

                        <div id="toggleSidenavBtn">
    
                            <svg xmlns="http://www.w3.org/2000/svg" width="19.394" height="28.21" viewBox="0 0 19.394 28.21">
                                <path id="Icon_awesome-lightbulb" data-name="Icon awesome-lightbulb" d="M5.293,25.033a1.764,1.764,0,0,0,.3.975l.942,1.415A1.763,1.763,0,0,0,8,28.21h3.4a1.763,1.763,0,0,0,1.468-.787l.942-1.415a1.762,1.762,0,0,0,.3-.975l0-2.113H5.29l0,2.113ZM0,9.7a9.643,9.643,0,0,0,2.4,6.379,15.834,15.834,0,0,1,2.877,5.039c0,.014.006.043.006.043h8.829c0-.014,0-.028.006-.043a15.834,15.834,0,0,1,2.877-5.039A9.7,9.7,0,1,0,0,9.7ZM9.7,5.289A4.413,4.413,0,0,0,5.289,9.7a.882.882,0,0,1-1.763,0A6.178,6.178,0,0,1,9.7,3.526a.882.882,0,0,1,0,1.763Z" transform="translate(0 0)"></path>
                            </svg>
    
                        </div>
    
                    </div>
    
                    <!-- Light/dark mode btn -->
                    <div class="mode">
    
                        <label class="toggle-mode">

                            {% if profile.dark_mode %}
                            
                                <input class='toggle-checkbox' id="modeCB" type='checkbox' checked></input>
    
                                <script>
    
                                    $('body').addClass('dark');
    
                                </script>
    
                            {% else %}
    
                                <input class='toggle-checkbox' id="modeCB" type='checkbox'></input>
    
                            {% endif %}

                            <div class='toggle-slot'>
                            <div class='sun-icon-wrapper'>
                                <div class="iconify sun-icon" data-icon="feather-sun" data-inline="false"></div>
                            </div>
                            <div class='toggle-button'></div>
                            <div class='moon-icon-wrapper'>
                                <div class="iconify moon-icon" data-icon="feather-moon" data-inline="false"></div>
                            </div>
                            </div>

                        </label>
    
                    </div>
    
                    <div class="profile">
    
                        <div class="initials">
    
                            <span>{{ profile.initials }}</span>
    
                        </div>
    
                    </div>

                </div>

            </div>

            <!-- Add note btn -->

            <form idd="newNoteForm">

                <input type="text" name="b" id="newNoteFolder" hidden/>
                <input type="checkbox" name="l" id="lovedSection" hidden/>
                <input type="checkbox" name="a" id="archivedSection" hidden/>

                <a href="/register">

                    <button
                        type="button"
                        id="newNoteAllowed"
                        class="add-note-btn">+</button>

                </a>

            </form>

            <!-- SideNav -->
            <div class="sidenav">

                <div 
                    class="page active"
                    id="homeSection"
                    hx-get="{% url 'app:home' %}"
                    hx-target=".notes"
                    hx-trigger="click delay:0.5s">

                    <div class="icon">

                        <svg class="home" xmlns="http://www.w3.org/2000/svg" width="29.174" height="25.726" viewBox="0 0 29.174 25.726">
                            <path id="Icon_material-home" data-name="Icon material-home" d="M14.192,28.373c1.755-2.106-1.4-6.319,0-8.426a3.286,3.286,0,0,1,5.617,0c1.4,2.106-1.755,6.319,0,8.426s5.266,2.809,7.022,0,0-11.234,0-11.234,6.67,3.16,4.213,0S24.023,4.5,17,4.5,5.416,13.979,2.958,17.139s4.213,0,4.213,0-1.755,8.426,0,11.234S12.437,30.48,14.192,28.373Z" transform="translate(-2.414 -4.5)"/>
                        </svg>

                    </div>

                    <span class="page-title">Дом</span>

                </div>

                <div 
                    class="page" 
                    id="lovedSection"
                    hx-get="{% url 'app:loved' %}"
                    hx-target=".notes"
                    hx-trigger="click delay:0.5s">

                    <div class="icon">

                        <svg style="fill: #e31b23; padding-top: 2px;" xmlns="http://www.w3.org/2000/svg" width="24.806" height="21.933" viewBox="0 0 24.806 21.933">
                            <path id="Icon_awesome-heart" data-name="Icon awesome-heart" d="M22.4,3.747a6.576,6.576,0,0,0-9.04.666l-.954.994-.954-.994a6.576,6.576,0,0,0-9.04-.666,7.08,7.08,0,0,0-.48,10.178L11.3,23.707a1.508,1.508,0,0,0,2.195,0l9.375-9.781A7.076,7.076,0,0,0,22.4,3.747Z" transform="translate(0.001 -2.248)"/>
                        </svg>

                    </div>

                    <span class="page-title" style="color: #e31b23;">Любимое</span>

                </div>

                <div class="page" id="newFolderInit">

                    <div class="icon">

                        <span>+</span>

                    </div>

                    <span class="page-title">Новый блокнот</span>

                </div>

                <a href="/register">

                    <div 
                        class="page"
                        id="archiveSection"
                        >

                        <div class="icon">

                            <svg xmlns="http://www.w3.org/2000/svg" width="25.015" height="22.657" viewBox="0 0 25.015 22.657">
                                <g id="Icon_ionic-ios-archive" data-name="Icon ionic-ios-archive" transform="translate(-3.375 -4.5)">
                                <path id="Контур_1" data-name="Контур 1" d="M28.149,7.761H3.616a.238.238,0,0,1-.241-.233V6.363A1.892,1.892,0,0,1,5.3,4.5H26.465A1.892,1.892,0,0,1,28.39,6.363V7.528A.238.238,0,0,1,28.149,7.761Z"/>
                                <path id="Контур_2" data-name="Контур 2" d="M27.169,10.266H4.982a.476.476,0,0,0-.482.466V25.988a1.9,1.9,0,0,0,1.929,1.863H25.722a1.9,1.9,0,0,0,1.929-1.863V10.731A.476.476,0,0,0,27.169,10.266ZM19.09,18.534h-6a.856.856,0,0,1-.862-.716.826.826,0,0,1,.838-.914h6a.856.856,0,0,1,.862.716A.829.829,0,0,1,19.09,18.534Z" transform="translate(-0.193 -0.694)"/>
                                </g>
                            </svg>

                        </div>

                        <span class="page-title">Архив</span>

                    </div>

                </a>

                <a href="/register">

                    <div 
                        class="page"
                        id="trashSection"
                        >

                        <div class="icon">

                            <svg xmlns="http://www.w3.org/2000/svg" width="18.008" height="24.68" viewBox="0 0 18.008 24.68">
                                <g id="Icon_ionic-ios-trash" data-name="Icon ionic-ios-trash" transform="translate(-8.297 -4.5)">
                                <path id="Контур_3" data-name="Контур 3" d="M9.359,9l1.525,20.44a1.981,1.981,0,0,0,1.894,2.06h9.114a1.981,1.981,0,0,0,1.894-2.06L25.292,9ZM13.34,27.633,12.907,11.25h1.2l.446,16.383Zm4.544,0H16.721V11.25h1.164Zm3.381,0h-1.2L20.5,11.25h1.2Z" transform="translate(0 -2.32)"/>
                                <path id="Контур_4" data-name="Контур 4" d="M24.347,6.469H22L20.283,4.852a1.269,1.269,0,0,0-.861-.352H15.193a1.288,1.288,0,0,0-.874.352L12.6,6.469H10.254A1.733,1.733,0,0,0,8.3,8.3H26.3A1.733,1.733,0,0,0,24.347,6.469Z"/>
                                </g>
                            </svg>

                        </div>

                        <span class="page-title">Корзина</span>

                    </div>

                </a>

            </div>
            
            <!-- Notes -->
            <div class="notes">

                {% include 'components/notes.html' %}

                <div class="first-note">

                    <span class="warn-text">Зафиксируй мгновение 💡</span>
                    <span class="cta-text">Создай первую заметку ✍</span>
                    <a href="/register">

                        <button 
                            type="submit"
                            class="cta-btn"
                            >Создать заметку</button>

                    </a>

                </div>

            </div>

        </div>

    </body>

    <script>

        

    </script>

    <style>

        @font-face {

            font-family: Comfortaa;
            src: url("{% static 'fonts/Comfortaa.ttf' %}");

        }

        @font-face {

            font-family: SG;
            src: url("{% static 'fonts/ShowcardGothic.otf' %}");
        
        }

    </style>

    <!-- universal -->
    <script>

        document.body.addEventListener('htmx:configRequest', (event) => {

            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';

        });

        function delay(callback, ms) {

            var timer = 0;

            return function() {

                var context = this, args = arguments;
                clearTimeout(timer);
                
                timer = setTimeout(function () {

                    callback.apply(context, args);

                }, ms || 0);

            };
            
        };

        function validateEmail(e) {

            var re = /\S+@\S+\.\S+/;
            return re.test(e);

        }

        function hasNumber(myString) {

            return /\d/.test(myString);
        
        }

    </script>

    <!-- Search -->

    <script>

        $('.search-icon-wrapper').click(function() {

            $('#noteSearchWrapper').show();

            $('.search-icon-wrapper').css({

                'top': -60,
                'left': 5,
                'box-shadow': 'none',

            });

            $('#cancelSearch').show();
            $('#cancelSearch').css('opacity', 1);

            
        });
        
        $('#cancelSearch').click(function() {
            
            $('#noteSearchWrapper').hide();

            $('.search-icon-wrapper').css({

                'top': -63,
                'left': 90,
                'box-shadow': '3px 3px 8px #d8cec4, -3px -3px 8px #fffffa',

            });

        });

    </script>

    <!-- Sidenav close on page click -->
    <script>

        $('.page').click(function() {

            toggleSidenav();
            $('#toggleSidenavBtn').removeClass('active');
            
        });

    </script>

    <!-- First note cta -->

    <script>

        if ($('.note-section').children('.note').length == 0) {

            $('.first-note').css('display', 'flex');
            $('.note-section-title').hide();

        };
        
        $('.cta-btn').click(function() {

            $('.first-note').hide();

            $('.current-note').show();
            $('.current-note').animate({

                'opacity': 1,

            }, 250);

        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target === document.getElementsByClassName('notes')[0]) {

                newNoteUID = $('#otherNotes').children(':first-child').children('.note-actions').children('#noteUID').val();

                $('.current-note-uid').val(newNoteUID);

            }
    
        });

    </script>


   <!-- Premium restrictions -->

   {% if not user.profile.premium %}

   <script>

       /* Notes */

       setInterval(function() {

                if ($('.note-section').children('.note').length >= 3) {

                    $('#newNoteNotAllowed').show();
                    $('#newNoteAllowed').hide();

            }

            /* Folders */

            if ($('.folders').children('.page').length >= 1) {

                $('#newFolderInit').addClass('notAllowed');
                $('#createFolderInNoteNew').hide();
                $('#createFolderInNote').hide();
                
            }

       }, 100);
       
   </script>

{% endif %}

    <!-- Friend premium -->
    <script>

        $('#copyLinkBtn').click(function() {

            $('#inviteLink').select();
            document.execCommand('copy');
            document.getSelection().removeAllRanges();

            $('.invite-link').animate({

                'opacity': 0,

            }, 500);

            setTimeout(function() {

                $('.invite-link').html('');
                $('.invite-link').html(`
                
                    <span class='finish-invite'>Ссылка скопирована! <br> Отправьте ее своим друзьям 😌</span>

                `);

                $('.invite-link').animate({

                    'opacity': 1,

                }, 500);

            }, 500);

        })

    </script>

    <!-- Mode -->
    <script>

        $('#modeCB').change(function() {

            $('body').toggleClass('dark')

            $.ajax({

                type: 'POST',

                url: "{% url 'user:toggle-mode' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',

                }

            });

        });

    </script>

    <!-- Profile -->
    <script>

        /* Dropdown */

        profileDropdownOpen = false;
        
        $('.profile').click(function() {

            $('.initials').toggleClass('active');

            if (profileDropdownOpen) {

                $('.profile-dropdown').animate({'opacity': 0}, 250);

                setTimeout(function() {

                    $('.profile-dropdown').hide();

                }, 250);

                profileDropdownOpen = false;

            } else {

                $('.profile-dropdown').show();
                $('.profile-dropdown').animate({'opacity': 1}, 250);

                profileDropdownOpen = true;

            }

        });

        /* Button & dropdown animation */

        $('#myAccount, #logout').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('.btn').removeClass('active');

            }, 250);

                /* Hide profile dropdown */
            $('.initials').removeClass('active');

            $('.profile-dropdown').animate({'opacity': 0}, 250);

            setTimeout(function() {

                $('.profile-dropdown').hide();

            }, 250);

            profileDropdownOpen = false;

        });

        /* Account preferences */

        accountFormOpen = false;

            /* Form render */
        $('#myAccount').click(function() {

            accountFormOpen = true;

            $('.account-preferences').css('display', 'flex');
            $('.account-preferences').animate({

                'opacity': 1,

            }, 250);

            oldName = $('#profileNameVal').val();
            oldEmail = $('#profileEmailVal').val();

        });

            /* Close form */
        $('#closeAccountPreferences').click(function() {

            accountFormOpen = false;

            $('#closeAccountPreferences').addClass('active');

            $('.account-preferences').animate({

                'opacity': 0,

            }, 250);

            setTimeout(function() {

                $('#closeAccountPreferences').removeClass('active');

                $('.account-preferences').hide();

                $('#emailError').hide();
                $('#nameError').hide();
                $('#passwordError').hide();
                $('#profilePasswordVal').val('');

            }, 250);

        });

            /* Field logic */

        /* Name */
        document.getElementById('profileNameVal').addEventListener('input', function() {

            $('#nameError').hide();
            $('#nameOK').hide();

        });

        document.getElementById('profileNameVal').addEventListener('input', delay(function() {

            if (!$('#profileNameVal').val()) {

                $('#nameError').show();

            } else {

                $('#nameOK').show();

                setTimeout(function() {

                    $('#nameOK').hide();

                }, 1500);

                newName = $('#profileNameVal').val();

                if (newName != oldName) {

                    $.ajax({

                        type: 'POST',

                        url: "{% url 'user:cn' %}",

                        data: {

                            'csrfmiddlewaretoken': "{{ csrf_token }}",
                            'n': newName,

                        }

                    });

                }

            }
            
        }, 750));

        /* Email */
        document.getElementById('profileEmailVal').addEventListener('input', function() {

            $('#emailError').hide();
            $('#emailOK').hide();

        });

        document.getElementById('profileEmailVal').addEventListener('input', delay(function() {

            newEmail = $('#profileEmailVal').val();

            if (!validateEmail(newEmail)) {

                $('#emailError').show();

            } else {

                $('#emailOK').show();

                setTimeout(function() {

                    $('#emailOK').hide();

                }, 1500);

                if (newEmail != oldEmail) {

                    $.ajax({

                        type: 'POST',

                        url: "{% url 'user:cu' %}",

                        data: {

                            'csrfmiddlewaretoken': "{{ csrf_token }}",
                            'e': newEmail,

                        }

                    });

                }

            }
            
        }, 750));

        /* Password */

        document.getElementById('profilePasswordVal').addEventListener('input', function() {

            $('#passwordError').hide();
            $('#passwordOK').hide();

        });

        document.getElementById('profilePasswordVal').addEventListener('input', delay(function() {

            newPassword = $('#profilePasswordVal').val();

            if (newPassword.length < 7 || !hasNumber(newPassword)) {

                $('#passwordError').show();

            } else {
                
                $('#passwordOK').show();

                setTimeout(function() {

                    $('#passwordOK').hide();

                }, 1500);


                $.ajax({

                    type: 'POST',

                    url: "{% url 'user:cp' %}",

                    data: {

                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                        'p': newPassword,

                    }

                });

            }
            
        }, 750));

    </script>
    
    <!-- Sidenav -->
    <script>

        sidenavOpen = false;

        function toggleSidenav() {

            if ($('.sidenav').hasClass('open')) {

                $('.sidenav').removeClass('open');

                $('.page-title').hide();
                $('.page-title').css('opacity', 0);

                $('.edit-folder-btn-init').hide();
                $('.edit-folder-btn-init').css('opacity', 0);
                
            } else {

                $('.sidenav').addClass('open');

                $('.page-title').show();
                $('.page-title').animate({'opacity': 1}, 750);

                setTimeout(function() {

                    $('.edit-folder-btn-init').css('display', 'flex');

                    $('.edit-folder-btn-init').animate({

                        'opacity': 1,

                    }, 250);

                }, 500);

            }

        }

        $('#toggleSidenavBtn').click(function() {

            $(this).toggleClass('active');

            toggleSidenav();
            
            sidenavOpen = !sidenavOpen;

        });

        $('body').on('click', '#homeSection, #lovedSection, #folderSection, #archiveSection, #trashSection', function(e) {
        
            $('.page').removeClass('active');
            $(this).addClass('active');

            $('.notes').animate({'opacity': 0}, 500);

            setTimeout(function() {

                $('.notes').animate({'opacity': 1}, 500);

            });

        });

        $('body').on('click', '#newFolderInit', function() {

            $('#newFolderInit').addClass('active');

            setTimeout(function() {

                $('#newFolderInit').removeClass('active');

            }, 250);

        });

        
        /* Edit folder */

        editFolderFormShown = false;

        $('body').on('click', '.edit-folder-btn-init', function() {

            editFolderFormShown = true;

            editFolderBtn = $(this);

            editFolderBtn.addClass('active');

            setTimeout(function() {

                editFolderBtn.removeClass('active');

            }, 250);
 
            editingFolderUID = $(this).siblings('#folderUID').val();
            previousTitle = $(this).siblings('.page-title').children('span').text();

            $('#editFolderTitle').val(previousTitle);
            $('#deleteFolderUID').val(editingFolderUID);

            $('.edit-folder').css('display', 'flex');
            $('.edit-folder').animate({'opacity': 1}, 250);

        });

            /* Folder title checks (emptiness) & (uniqueness) */

        document.getElementById('editFolderTitle').addEventListener('input', function() {
        
            if ($(this).val().trim().length === 0) {

                $('.edit-folder-btn').prop('disabled', true);

            } else {

                newTitle = $(this).val();

                titleUnique = true;

                $('.folders').children('.page').each(function() {

                    title = $(this).children('.page-title').children('span').text();
                        
                    if (title == newTitle) {

                        titleUnique = false;

                    }

                });
                
                if (titleUnique) {

                    $('.edit-folder-btn').prop('disabled', false);

                } else {

                    $('.edit-folder-btn').prop('disabled', true);

                }        

            }

        }, false);

            /* Close form */
        $('#closeEditFolderForm, .edit-folder-btn, .delete-folder-btn').click(function() { 

            editFolderFormShown = false;

            $('.edit-folder-btn-init').removeClass('active');

            $('.edit-folder').animate({'opacity': 0}, 250);

            setTimeout(function() {

                $('.edit-folder').css('display', 'none');

            }, 250);

        });

        $('#closeEditFolderForm').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('#closeEditFolderForm').removeClass('active');

            }, 250);

        });

        $('.edit-folder-btn-init').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('.edit-folder-btn-init').removeClass('active');

            }, 250);

        });

        $('.delete-folder-btn').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('.delete-folder-btn').removeClass('active');

            }, 250);

        });
        
            /* Redirect to home section if folder has been deleted */
        $('.delete-folder-btn').click(function() {

            document.getElementById('homeSection').click();

        });

            /* Update folder title */
        $('.edit-folder-btn').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('.edit-folder-btn').removeClass('active');

            }, 250)

            $('.folders').children('.page').each(function() {

                if ($(this).children('#folderUID').val() == editingFolderUID) {

                    $(this).children('.page-title').children('span').text($('#editFolderTitle').val());

                }

            });

            $('.note-section-title').text($('#editFolderTitle').val());

            /* Submit ajax request only if the title has changed */

            if ($('#editFolderTitle').val() != previousTitle) {

                $.ajax({

                    type: 'POST',

                    url: "{% url 'app:edit-folder' %}",

                    data: {

                        'csrfmiddlewaretoken': "{{ csrf_token }}",
                        'u': editingFolderUID,
                        't': $('#editFolderTitle').val(),

                    }

                });

            }

        });

        /* Icon bug */

        setInterval(function() {

            if ($('.page').width() == '55') {

                $('.edit-folder-btn-init').hide();

                $('.page-title').css('opacity', 0);

            }

        }, 10);

    </script>

    <!-- Pop-ups -->

    <script>

        /* Premium */

        premiumPopUpOpen = false;

        $('.premium-btn').click(function() { 

            $(this).addClass('in');

            setTimeout(function() {

                $('.premium-btn').removeClass('in');

            }, 250);

            premiumPopUpOpen = true;

            $('.premium-offer').css('display', 'flex');
            $('.premium-offer').animate({

                'opacity': 1,

            }, 500);

        });

        $('#closePremiumOfferBtn').click(function() {

            premiumPopUpOpen = false;

            $(this).addClass('active');

            $('.premium-offer').animate({

                'opacity': 0,

            }, 250);

            setTimeout(function() {

                $('.premium-offer').hide();

                $('#closePremiumOfferBtn').removeClass('active');

            }, 250);

        });

    </script>

    <!-- Search notes -->
    <script>

        /* Change placeholder depending on device width */

        if ($(window).width() <= 775) {

            $('#noteSearch').attr('placeholder', 'Искать');

        } else {

            $('#noteSearch').attr('placeholder', 'Искать заметку');

        }

        $(window).resize(function() {

            if ($(window).width() <= 775) {

                $('#noteSearch').attr('placeholder', 'Искать');

            } else {

                $('#noteSearch').attr('placeholder', 'Искать заметку');

            }

        });

        document.getElementById('noteSearch').addEventListener('input', function() {

            $('#cancelSearch').css('display', 'flex');
            $('#cancelSearch').animate({'opacity': 1}, 250);

        }, false);

        $('body').on('click', '#cancelSearch', function() {

            $('#noteSearch').val('');
            $(this).animate({'opacity': 0}, 250);

            setTimeout(function() {

                $('#cancelSearch').hide();

            }, 250)   

        });

    </script>
    
    <script>

        $('#newNoteAllowed').click(function() {

            $('.current-note').show();

            $('.current-note').animate({

                'opacity': 1,

            }, 250);

        });

        $('#newNoteNotAllowed').click(function() {

            premiumPopUpOpen = true;

                $('.premium-offer').css('display', 'flex');
                $('.premium-offer').animate({

                    'opacity': 1,

                }, 500);

        })

        /* Get UID of newly added note and paste it to current note props */

        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target === document.getElementsByClassName('notes')[0]) {

                newNote = $('#otherNotes').children('.note').first();

                newUID = newNote.children('.note-actions').children('#noteUID').val();

                $('.current-note-uid').val(newUID);
                $('#currentNoteUID').val(newUID);

            }

        });

    </script>


    <!-- Folders -->
    <script>

        /* Creation */

        folderFormShown = false;

            /* Form show */

        $('#newFolderInit').click(function() {

            if ($(this).hasClass('notAllowed')) {

                premiumPopUpOpen = true;

                $('.premium-offer').css('display', 'flex');
                $('.premium-offer').animate({

                    'opacity': 1,

                }, 500);

            } else {

                folderFormShown = true;

                $('#newFolderTitle').val('');
                $('.create-folder-btn').prop('disabled', true);

                $('.create-folder').css('display', 'flex');
                $('.create-folder').animate({'opacity': 1}, 250);

            }

        });

            /* Form hide */

        $('#closeNewFolderForm, .create-folder-btn').click(function() {

            folderFormShown = false;

            $('.create-folder').animate({'opacity': 0}, 250);

            setTimeout(function() {

                $('.create-folder').css('display', 'none');

            }, 250);

        });

            /* Close new folder form */    
        $('#closeNewFolderForm').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('#closeNewFolderForm').removeClass('active');

            }, 250);

        });

            /* Create folder btn */
        $('.create-folder-btn').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('.create-folder-btn').removeClass('active');

            }, 250);

        });

            /* Close new folder form */
        $('#closeNewFolderForm').click(function() {

            $(this).addClass('active');

            setTimeout(function() {

                $('#closeNewFolderForm').removeClass('active');

            }, 250);

        });

            /* Go to folder once folder is created */
        document.body.addEventListener('htmx:afterSwap', function(e) {

            if (e.detail.target === document.getElementsByClassName('folders')[0]) {

                $('.folders').children('.page').each(function() {

                    if ($(this).children('.page-title').children('span').text() === newTitle) {
                        
                        $(this).click();

                        uid = $(this).children('#folderUID').val();
                        $('#currentFolder').val(uid);
                        
                        $('.note-section-title').text(newTitle);
                        $('.note-section').hide();

                    }

                });

            }

        });

            /* Folder title checks (emptiness) & (uniqueness) */
        document.getElementById('newFolderTitle').addEventListener('input', function() {
            
            if ($(this).val().trim().length === 0) {

                $('.create-folder-btn').prop('disabled', true);

            } else {

                newTitle = $(this).val();

                titleUnique = true;

                $('.folders').children('.page').each(function() {

                    title = $(this).children('.page-title').children('span').text();
                        
                    if (title == newTitle) {

                        titleUnique = false;

                    }

                });
                
                if (titleUnique) {

                    $('.create-folder-btn').prop('disabled', false);

                } else {

                    $('.create-folder-btn').prop('disabled', true);

                }        

            }

        }, false);

    </script>

    <!-- Current note -->
    <script>

        noteOpen = false;

        /* Before window is closed */

        window.onbeforeunload = function() {

            if (noteChanged) {

                return 'Не уходите! Ваша заметка сохраняется c:';

            }

        }

        window.onunload = function() {

            if (noteChanged) {

                return 'Не уходите! Ваша заметка сохраняется.';

            }

        }

        /* On note load */

        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target === document.getElementById('currentNoteContents')) {

                /* Paste data from GET request */

                    /* Text */
                $('.current-note-uid').val($('#currentNoteUID').val());
                $('.current-note-title').val($('#currentNoteTitle').val());
                $('.current-note-content').html($('#currentNoteContent').val());


                    /* Photos */
                if ($('#currentNotePhotos').children().length > 0) {

                    $('#photosCurrent').css('display', 'block');

                    $('#currentNotePhotos').children('.photo').each(function() {

                        $('#photosCurrent').append($(this));

                    });

                }

                    /* Folders  */
                noteFolders = [];
                
                if ($('#currentNoteFolders').children('.folder').length === 0) {

                    $('.current-note-folders').hide();

                } else {

                    $('.current-note-folders').show();

                    $('#currentNoteFolders').children('.folder').each(function() {

                        noteFolders.push($(this).children('input').val());
                        $(this).appendTo('.current-note-folders');

                    });

                }

                $('body').css('overflow', 'hidden');
                
                    /* Render the note */
                $('#currentNoteContents').hide();

                $('.current-note').css('display', 'flex');
                $('.current-note').animate({'opacity': 1}, 500);

                noteOpen = true;
                photoOpen = false;

            }
    
        });

        /* Autosave */

        var delay = (function(){
            var timer = 0;
            return function(callback, ms){
                clearTimeout (timer);
                timer = setTimeout(callback, ms);
            };
        })();

            /* Title */
        document.getElementsByClassName('current-note-title')[0].addEventListener('input', function() {

            title = $('.current-note-title').val();
            noteUID = $('.current-note-uid').val();

            noteChanged = true;

            delay(function() {

                if (noteOpen) {

                    $.ajax({

                        type: 'POST',

                        url: "{% url 'app:update-title' %}",

                        data: {

                            'csrfmiddlewaretoken': '{{ csrf_token }}',

                            't': title,
                            'u': noteUID,

                        }

                    });

                    noteChanged = false;

                }

            }, 2000);

            $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                if ($(this).children('.note-actions').children('#noteUID').val() == noteUID) {

                    $(this).children('.text').children('.title').text(title);

                }

            });

        }, false);

            /* Content */

        document.getElementsByClassName('current-note-content')[0].addEventListener('input', function() {

            content = $('.current-note-content').html();
            noteUID = $('.current-note-uid').val();

            noteChanged = true;

            delay(function() {

                if (noteOpen) {

                    $.ajax({

                        type: 'POST',

                        url: "{% url 'app:update-content' %}",

                        data: {

                            'csrfmiddlewaretoken': '{{ csrf_token }}',

                            'c': content,
                            'u': noteUID,

                        }

                    });

                    noteChanged = false;

                }

            }, 2000);

            $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                if ($(this).children('.note-actions').children('#noteUID').val() == noteUID) {

                    $(this).children('.text').children('.content').html(content);

                }

            });

        }, false);

        /* Photos */

            /* Trash icon on hover */

        $('body').on('mouseover', '.photo', function() {

            $(this).children('#removePhoto').animate({'opacity': 1}, 250);

        });
        
        $('body').on('mouseleave', '.photo', function() {

            $(this).children('#removePhoto').animate({'opacity': 0}, 250);

        });

            /* Display photos div on upload */

        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target === document.getElementById('photosCurrent')) {

                $('#photosCurrent').show();

            }
    
        });

            /* Full reso on click */

        $('body').on('click', '.photo', function(e) {

            if ($(e.target).is('img')) {

                openedPhoto = $(this).children('img').clone();
                previousPhotos = $(this).prevAll();
                nextPhotos = $(this).nextAll();

                if (previousPhotos.length > 0) {$('#previousPhoto').show();}
                if (nextPhotos.length > 0) {$('#nextPhoto').show();}
                
                previousPhotos.each(function() {
                    
                    photo = $(this).children('img').clone();
                    photo.css('display', 'none');
                    photo.appendTo('.photo-carousel');
                    
                });
                
                openedPhoto.attr('id', 'currentPhoto');
                openedPhoto.appendTo('.photo-carousel');

                nextPhotos.each(function() {

                    photo = $(this).children('img').clone();
                    photo.css('display', 'none');
                    photo.appendTo('.photo-carousel');

                });

                $('.photo-carousel').css('display', 'flex');
                $('.photo-carousel').animate({'opacity': 1}, 250);

                photoOpen = true;
                
            }

        });

            /* Next & Previous photos logic */
        $('body').on('click', '#nextPhoto', function() {

            nextPhoto = $('#currentPhoto').next();

            nextPhoto.css('display', 'block');
            $('#currentPhoto').hide();

            $('#currentPhoto').attr('id', '');
            nextPhoto.attr('id', 'currentPhoto');

            $('#previousPhoto').show();

            if (nextPhoto.nextAll().length === 0) {$('#nextPhoto').hide();}

        });

        $('body').on('click', '#previousPhoto', function() {

            previousPhoto = $('#currentPhoto').prev();

            previousPhoto.css('display', 'block');
            $('#currentPhoto').hide();

            $('#currentPhoto').attr('id', '');
            previousPhoto.attr('id', 'currentPhoto');

            $('#nextPhoto').show();

            if (previousPhoto.prevUntil('button').length === 0) {$('#previousPhoto').hide();}

        });

            /* Close full reso on btn click/esc */

        function closePhotoCarousel() {

            $('.photo-carousel').animate({'opacity': 0}, 250);
            
            setTimeout(function() {

                $('#nextPhoto').hide();
                $('#previousPhoto').hide();

                $('.photo-carousel').hide();
                $('.photo-carousel').children('img').each(function(){$(this).remove();})

            }, 250);

            photoOpen = false;

        }

        $('body').on('click', '#closePhoto', function() {

            closePhotoCarousel();

        });

            /* Delete */

        $('body').on('click', '#removePhoto', function() {

            photoToRemove = $(this).parent();

            photoToRemove.animate({opacity: 0}, 500);

            setTimeout(function() {

                photoToRemove.remove();

                if ($('#photosCurrent').children().length === 0) {

                    $('#photosCurrent').hide();

                }

            }, 500);

            $.ajax({

                type: 'POST',

                url: "{% url 'app:delete-photo' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    
                    'n': $('.current-note-uid').val(),
                    'p': $(this).siblings('input').val(),

                },

            });

        });

        /* Remove folders at footer */

        $('body').on('mouseover', '.folder', function() {

            $(this).children('#removeFolder').animate({'opacity': 1}, 250);

        });

        $('body').on('mouseleave', '.folder', function() {

            $(this).children('#removeFolder').animate({'opacity': 0}, 250);

        });

        $('body').on('click', '#removeFolder', function() {

            $(this).addClass('active');

            uid = $(this).siblings('#folderUID').val();
            folderTitle = $(this).siblings('span').text();

            noteFolders.pop(uid);
            folderSearchInit();

            folder = $(this).parent();
            folder.animate({'opacity': 0}, 250);

            setTimeout(function() {
                
                folder.remove();

                if ($('.current-note-folders').children('.folder').length === 0) {

                    $('.current-note-folders').hide();

                }
            
            }, 250);

            $.ajax({

                type: 'POST',

                url: "{% url 'app:remove-folder' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',

                    'f': $(this).siblings('#folderUID').val(),
                    'n': $('.current-note-uid').val(),

                }

            });

            $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                if ($(this).children('.note-actions').children('#noteUID').val() == $('.current-note-uid').val()) {

                    $(this).children('.folders').children('.folder').each(function() {
                        
                        if ($(this).children('.folder-title').text() == folderTitle) {

                            $(this).remove();

                        }

                    });

                    if ($(this).children('.folders').children('.folder').length === 0) {

                        $(this).children('.folders').remove();

                    }

                }

            });

        });

        /* Note folders search */

            /* init */
        folderSearchOpen = false;
        noteFolders = [];

        function folderSearchInit() {

            $('.folder-list').html('');

            $('.folders').children('.page').each(function() {

                uid = $(this).children('#folderUID').val();
                title = $(this).children('.page-title').children('span').text();
                    
                if (!noteFolders.includes(uid) && uid != '') {
                                                                
                    $('.folder-list').append(

                        `

                            <div id='noteFolder'>

                                <input type='text' value='` + uid + `'/>
                                <span class='title'>` + title + `</span>

                            </div>

                        `

                    );

                } else if (noteFolders.includes(uid)) {

                    $('.folder-list').prepend(

                        `

                            <div id='noteFolder' class='inNote'>

                                <input type='text' value='` + uid + `'/>
                                <span class='title'>` + title + ` </span>

                            </div>

                        `

                    );

                }

            });

            if ($('.folder-list').children('#noteFolder').length == 0) {
                
                $('.folder-list').hide();
                
            } else if ($('.folder-list').children('#noteFolder').length == 1) {
                    
                $('#noteFolder:last-child').css('margin', 0);
                $('#createFolderInNoteNew').css('top', 70);
                    
            } else {
                
                $('#noteFolder').css('marginBottom', 15);
                $('#noteFolder:last-child').css('margin', 0);
                $('#createFolderInNoteNew').css('top', 70);

            }

        }

        $('body').on('click', '#noteFolder', function() {

            noteUID = $('.current-note-uid').val();

            folderUID = $(this).children('input').val();
            folderTitle = $(this).children('span').text();

            if (!$(this).hasClass('inNote')) {

                $(this).addClass('inNote');

                $('.current-note-folders').show();

                $('.current-note-folders').append(

                    `

                        <div class='folder'>

                            <input
                                type='text'
                                value='` + folderUID + `'
                                hidden />

                            <span>` + folderTitle + `</span>
                            <button id='removeFolder'>×</button

                        </div>

                    `

                );

                noteFolders.push(folderUID);

                $.ajax({

                    type: 'POST',

                    url: "{% url 'app:add-folder' %}",

                    data: {

                        'csrfmiddlewaretoken': '{{ csrf_token }}',

                        'f': folderUID,
                        'n': $('.current-note-uid').val(),

                    }
                    
                });

                /* Add folder to note in note list */
                $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                    if ($(this).children('.note-actions').children('#noteUID').val() == noteUID) {

                        if ($(this).children('.folders').length === 0) {

                            $(this).append(

                                `
                                    <div 
                                        class='folders'
                                        hx-get="/get-note/` + noteUID + `/"
                                        hx-target="#currentNoteContents"></div>

                                `

                            )

                        }

                        $(this).children('.folders').append(

                            `
                                <div class='folder'>
                                    <span class='folder-title'>` + folderTitle + `</span>
                                </div>
                            `

                        )

                    }

                });

            } else {

                $(this).removeClass('inNote');

                $('.current-note-folders').children('.folder').each(function() {

                    if (folderUID == $(this).children('input').val()){$(this).remove();}

                });

                noteFolders.pop(folderUID);

                $.ajax({

                    type: 'POST',

                    url: "{% url 'app:remove-folder' %}",

                    data: {

                        'csrfmiddlewaretoken': '{{ csrf_token }}',

                        'f': folderUID,
                        'n': $('.current-note-uid').val(),

                    }
                    
                });

                if ($('.current-note-folders').children('.folder').length === 0) {

                    $('.current-note-folders').hide();

                }

                /* Remove folder from note in note list */
                $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                    if ($(this).children('.note-actions').children('#noteUID').val() == $('.current-note-uid').val()) {

                        $(this).children('.folders').children('.folder').each(function() {
                            
                            if ($(this).children('.folder-title').text() == folderTitle) {

                                $(this).remove();

                            }

                        });

                        if ($(this).children('.folders').children('.folder').length === 0) {

                            $(this).children('.folders').remove();

                        }

                    }

                });

                /* Remove note from note list if the folder removed is the current folder */
                if (clickedFolderTitle == $('.note-section-title').text()) {

                    currentNoteUID = $('.current-note-uid').val();

                    $('.notes').children('.wrapper').children('.note-section').each('.note').each(function() {

                        noteInstanceUID = $(this).children('.note-actions').children('#noteUID').val();

                        if (currentNoteUID == noteInstanceUID) {

                            $(this).remove();

                        }

                    })

                }

            }

        });

            /* Form render */

        $('#folderBtnCurrent').click(function() {

            if (!folderSearchOpen) {

                $('.current-note-folders-form').css('display', 'block');
                $('.current-note-folders-form').animate({'opacity': 1}, 250);

                folderSearchInit();

                folderSearchOpen = true;

                $(this).addClass('active');

            } else {

                closeFolderSearch();

                $(this).removeClass('active');
                
            }

        });

        $('#closeCurrentNoteFoldersForm').click(function() {

            closeFolderSearch();

            $(this).addClass('active');

            setTimeout(function() {

                $('#closeCurrentNoteFoldersForm').removeClass('active');

            }, 250);

        });

            /* Form remove */

        function closeFolderSearch() {

            $('.current-note-folders-form').animate({'opacity': 0}, 250);

            setTimeout(function() {
                
                $('.current-note-folders-form').css('display', 'none');

                $('.folder-search').val('');
                $('#searchFolderTitle').val('');
                $('.create-new-folder-from-search').hide();
                $('.folder-list').html('');


            }, 250);

            folderSearchOpen = false;

            $('#folderBtnCurrent').removeClass('active');

        }

            /* Search */

        $('.folder-search').on('input', function() {

            folderExists = false;

            $('#searchFolderTitle').val($(this).val());

            $('.folder-list').html('');

            $('.folder-list').show();

            if ($(this).val().trim().length === 0) {

                $('.create-new-folder-from-search-current').hide();

                folderSearchInit();

            } else {

                query = $(this).val();

                $('.folders').children('.page').each(function() {

                    uid = $(this).children('#folderUID').val();
                    title = $(this).children('.page-title').children('span').text().toString();

                    if (title === query) { /* Folder exists */

                        folderExists = true;

                    }

                    if (~title.indexOf(query)) {

                        if (noteFolders.includes(uid)) {

                            $('.folder-list').prepend(

                                `

                                    <div id='noteFolder' class='inNote'>

                                        <input type='text' value='` + uid + `' hidden />
                                        <span>` + title + ` </span>

                                    </div>

                                `

                            );

                        } else {

                            $('.folder-list').prepend(

                                `

                                    <div id='noteFolder'>

                                        <input type='text' value='` + uid + `' hidden />
                                        <span>` + title + ` </span>

                                    </div>

                                `

                            );

                        }

                    }

                });

                if (folderExists) {

                    $('.create-new-folder-from-search-current').hide();
                
                } else {

                    $('#createFolderInNote').text("Создать '" + query + "'");
                    $('.create-new-folder-from-search-current').show();

                }

                if ($('.folder-list').children('#noteFolder').length == 0) {
                    
                    $('.folder-list').hide();
                
                } else if ($('.folder-list').children('#noteFolder').length == 1) {

                    $('#noteFolder').css('margin', 0);

                } else {

                    $('#noteFolder').css('marginBottom', 15);
                    $('#noteFolder:last-child').css('margin', 0);
                    $('#createFolderInNoteNew').css('top', 70);

                }

            }

        });

            /* Sidenav folder opacity if open */
        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target == document.getElementsByClassName('folders')[0]) {

                if ($('.sidenav').hasClass('open')) {

                    $('.page-title').css('opacity', 1);

                }

            }

        })

            /* Creating folder from folder search (current note) */
        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target == document.getElementsByClassName('folders')[0] && noteOpen) {

                title = $('#searchFolderTitle').val();

                $('.folders').children('.page').each(function() {

                    if ($(this).children('.page-title').children('span').text() === title) {
                        
                        uid = $(this).children('#folderUID').val();

                        $('.current-note-folders').append(

                            `

                                <div class='folder'>

                                    <input
                                        type='text'
                                        value='` + uid + `'
                                        hidden />

                                    <span>` + title + `</span>
                                    <button id='removeFolder'>×</button

                                </div>

                            `

                        );

                        $.ajax({

                            type: 'POST',

                            url: "{% url 'app:add-folder' %}",

                            data: {

                                'csrfmiddlewaretoken': '{{ csrf_token }}',

                                'f': uid,
                                'n': $('.current-note-uid').val(),

                            }
                            
                        });

                        noteFolders.push(uid);

                    }

                });

                $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                    if ($(this).children('.note-actions').children('#noteUID').val() == $('.current-note-uid').val()) {

                        if ($(this).children('.folders').length > 0) {

                            $(this).children('.folders').append(

                                `
                                    <div class='folder'>
                                        
                                        <span class='folder-title'>` + title + `</span>

                                    </div>

                                `

                            );

                        } else {

                            $(this).append(`<div class='folders'></div>`);

                            $(this).children('.folders').append(

                                `
                                    <div class='folder'>
                                        
                                        <span class='folder-title'>` + title + `</span>

                                    </div>

                                `

                            );

                        }

                    }

                });

                $('.create-new-folder-from-search-current').hide();
                $('.folder-search').val('');
                $('.folder-search').focus();

                $('.current-note-folders').show();

                $('.folder-list').show();

                folderSearchInit();

            }
    
        });

        /* Close note */

        function closeNote() {

            $('.current-note').animate({'opacity': 0}, 250);
            closeFolderSearch();

            $('#boldBtnCurrent').removeClass('active');
            $('#italicBtnCurrent').removeClass('active');
            $('#underlineBtnCurrent').removeClass('active');
            $('#strikeBtnCurrent').removeClass('active');
            $('#ulBtnCurrent').removeClass('active');
            $('#olBtnCurrent').removeClass('active');

            /* Autosave */

            $.ajax({

                type: 'POST',

                url: "{% url 'app:update-contents' %}",

                data: {

                    'csrfmiddlewaretoken': '{{csrf_token}}',

                    'u': $('.current-note-uid').val(),
                    't': $('.current-note-title').val(),
                    'c': $('.current-note-content').html(),

                }

            });

            noteChanged = false;

            noteUID = $('.current-note-uid').val();

            /* Empty condition */

            if (!$('.current-note-title').val() && !$('.current-note-content').html()) {

                $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                    if ($(this).children('.note-actions').children('#noteUID').val() == noteUID) {

                        $(this).children('.empty').show();

                    }

                });

            } else {

                $('.notes').children('.wrapper').children('.note-section').children('.note').each(function() {

                    if ($(this).children('.note-actions').children('#noteUID').val() == noteUID) {

                        $(this).children('.empty').hide();

                    }

                });

            }

            setTimeout(function() {

                $('.current-note').css('display', 'none');

                $('.current-note-title').val('');
                $('.current-note-content').html('');

                $('#photosCurrent').html('');
                $('#photosCurrent').hide();

                $('.current-note-folders').html('');
            
            }, 250);

            noteOpen = false;

            $('body').css('overflow-y', 'auto');

        }

        $('#closeCurrentNote').click(function() {

            $(this).addClass('active');
            setTimeout(function() {$('#closeCurrentNote').removeClass('active')}, 250);

            closeNote();

        });

    </script>

    <!-- Close forms when ESC has been clicked -->
    <script>

        $('body').click(function(e) {

            if (noteOpen && $(e.target).is('.current-note')) {

                closeNote();

            }

        });

        $('body').keyup(function(e) {

            if (e.keyCode === 27) {

                if (window.opener && window.opener !== window) { /* We're in a pop-up */

                    console.log('p');

                } else {

                    if (folderFormShown) {

                        folderFormShown = false;

                        $('.create-folder').animate({'opacity': 0}, 250);

                        setTimeout(function() {
            
                            $('.create-folder').css('display', 'none');
            
                        }, 250);

                    } else if (accountFormOpen) {

                        $('.account-preferences').animate({

                            'opacity': 0,

                        }, 250);

                        setTimeout(function() {

                            $('#emailError').hide();
                            $('#nameError').hide();
                            $('#passwordError').hide();
                            $('#profilePasswordVal').val('');

                            $('#closeAccountPreferences').removeClass('active');

                            $('.account-preferences').hide();

                        }, 250);

                    } else if (premiumPopUpOpen) {

                        premiumPopUpOpen = false;

                        $('.premium-offer').animate({

                            'opacity': 0,

                        }, 250);

                        setTimeout(function() {

                            $('.premium-offer').hide();

                        }, 250);

                    } else if (editFolderFormShown) {

                        editFolderFormShown = false;

                        $('.edit-folder-btn').removeClass('active');

                        $('.edit-folder').animate({'opacity': 0}, 250);

                        setTimeout(function() {

                            $('.edit-folder').css('display', 'none');

                        }, 250);

                    } else if (noteOpen && !photoOpen && !folderSearchOpen) {

                        closeNote();

                    } else if (folderSearchOpen && !photoOpen) {

                        closeFolderSearch();

                    } else {

                        closePhotoCarousel();
                        photoOpen = false;

                    }

                }

            }

        });

    </script>

    <!-- Notes -->
    <script>

        $('body').on('click', '#cancelSearch', function() {

            $('.notes').animate({'opacity': 0}, 500);
            setTimeout(function() {

                $('.notes').animate({'opacity': 1}, 500);

            });

        });

        /* Note actions @hover */

        $('body').on('mouseover', '.note', function() {

            $(this).children('.note-actions').animate({'opacity': 1}, 250);
            $(this).children('.folders').css('overflow', 'auto');

        });

        $('body').on('mouseleave', '.note', function() {

            $(this).children('.note-actions').animate({'opacity': 0}, 250);
            $(this).children('.folders').css('overflow', 'hidden');

        });

        /* Note actions functionality */

        $('body').on('click', '#loveNote, #pinNote, #archiveNote, #deleteNote', function() {

            $(this).toggleClass('active');

        });

            /* Love */

        $('body').on('click', '#loveNote', function() {

            $.ajax({

                type: 'POST',

                url: "{% url 'app:love-note' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'n': $(this).siblings('#noteUID').val(),

                },

            });

        });

            /* Pin */

        $('body').on('click', '#pinNote', function() {

            /* Verify that we're not in the trash */

            if (!($('.note-section-title').text() == 'Корзина')) {

                note = $(this).parent().parent();

                if ($(this).hasClass('active')) { /* pin */

                    if ($('#pinnedNotes').length) {

                        note.insertAfter($('#pinnedNotes').children('.section-title'));

                    } else {

                        $(`<div class="note-section" id="pinnedNotes"><span class="section-title">Закрепленные заметки</span></div>`).insertAfter($('.note-section-title'))

                        note.insertAfter($('#pinnedNotes').children('.section-title'));
                        
                        if ($('#otherNotes').children('.note').length === 0) {

                            $('#otherNotes').remove();
                        
                        }

                    }

                    if ($('#otherNotes').children('.note').length === 0) {

                        $('#otherNotes').remove();

                    }

                    if ($('#otherNotes').children('.note').length > 0 && $('#otherNotes').children('.section-title').length === 0) {

                        $('#otherNotes').prepend(`<span class='section-title'>Другие заметки</span>`);

                    }

                } else { /* unpin */

                    if ($('#otherNotes').length) {

                        note.insertAfter($('#otherNotes').children('.section-title'));

                        if ($('#pinnedNotes').children('.note').length === 0) {
                            
                            $('#otherNotes').children('.section-title').remove();
                        
                        }

                    } else {

                        if ($('#pinnedNotes').children('.note').length === 1) {

                            $('.notes').children('.wrapper').append(

                                `

                                    <div class="note-section" id="otherNotes"></div>

                                `

                            );

                            note.appendTo('#otherNotes');

                        } else {

                            $('.notes').children('.wrapper').append(

                                `

                                    <div class="note-section" id="otherNotes">

                                        <span class="section-title">Другие заметки</span>

                                    </div>

                                `

                            );

                            note.insertAfter($('#otherNotes').children('.section-title'));

                        }

                    }

                    if ($('#pinnedNotes').children('.note').length === 0) {

                        $('#pinnedNotes').remove();

                    }
                
                }

            }

            $.ajax({

                type: 'POST',

                url: "{% url 'app:pin-note' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'n': $(this).siblings('#noteUID').val(),

                },

            });

        });

            /* Removing note section logic function */

        function pinLogic(pinned) {

            pinnedEmpty = false;
            otherEmpty = false;

            if (pinned) {

                if ($('#pinnedNotes').children('.note').length === 1) {

                    $('#pinnedNotes').animate({'opacity': 0}, 250);
                    pinnedEmpty = true;

                }

            } else {

                if ($('#otherNotes').children('.note').length === 1) {

                    $('#otherNotes').animate({'opacity': 0}, 250);
                    otherEmpty = true;

                }

            }

        }

            /* Archive */

        $('body').on('click', '#archiveNote', function() {

            /* Verify that the note is not in trash */

            if (!($('.note-section-title').text() == 'Корзина')) {

                note = $(this).parent().parent();
                pinned = $(this).siblings('#pinNote').hasClass('active');

                note.animate({'opacity': 0}, 250);
                
                pinLogic(pinned);

                setTimeout(function() {
                    
                    note.remove();

                    if (pinnedEmpty && !otherEmpty) {

                        $('#pinnedNotes').remove();

                    } else if (!pinnedEmpty && otherEmpty) {

                        $('#otherNotes').remove();

                    }
                
                }, 250);

            }
            
            $.ajax({

                type: 'POST',

                url: "{% url 'app:archive-note' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'n': $(this).siblings('#noteUID').val(),

                },

            });

        });

            /* Delete */

        $('body').on('click', '#deleteNote', function() {

            note = $(this).parent().parent();
            pinned = $(this).siblings('#pinNote').hasClass('active');
            
            pinLogic(pinned);

            setTimeout(function() {
                
                note.remove();

                if (pinnedEmpty && !otherEmpty) {

                    $('#pinnedNotes').remove();

                } else if (!pinnedEmpty && otherEmpty) {

                    $('#otherNotes').remove();

                }
            
            }, 250);

            $.ajax({

                type: 'POST',

                url: "{% url 'app:delete-note' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'n': $(this).siblings('#noteUID').val(),

                },

            });

            /* If the trash is empty, change the info */

            $('#emptyTrashBtn').remove();
            $('.empty-trash').children('.info').text('Корзина пуста!');

        });

        /* Empty note */

        $('.note').each(function() {

            title = $(this).children('.text').children('.title').text();
            content = $(this).children('.text').children('.content').html();

            uid = $(this).children('.note-actions').children('#noteUID').val();

            if (title === '' && content == '') {

                $(this).children('.empty').show();

            }
                    
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {

            if (evt.detail.target === document.getElementsByClassName('notes')[0]) {

                $('.note').each(function() {

                    text = $(this).children('.text');

                    title = text.children('.title').text();
                    content = text.children('.content').html();

                    uid = $(this).children('.note-actions').children('#noteUID').val();

                    if (title === '' && content == '') {

                        $(this).children('.empty').show();

                    }

                });

            }
    
        });

    </script>

    <script>

        newLineHTML = `

            <div><br></div>

        `

        $('body').on('keydown', function(e) {

            if (e.keyCode === 9) {

                e.preventDefault();

                if ($('.current-note-content').is(':focus')) {

                    var selection = window.getSelection();
                    var range = selection.getRangeAt(0);
                    var container = range.commonAncestorContainer;
                    var nodeParent = container.parentNode;


                    if (nodeParent.tagName == 'LI') {

                        nodeParent = nodeParent.parentNode;
                        document.execCommand('insertHTML', false, newLineHTML);
                        
                    }

                    if (nodeParent.tagName == 'UL') {

                        if (nodeParent.class == undefined) {
                            
                            document.execCommand('insertHTML', false, newLineHTML);

                        }

                    }

                }

                if (document.activeElement.class == 'current-note-content') {

                    pass;

                }
                
            }

        });

    </script>

    <!-- RTE -->
    <script>

        /* formatting check function */
        function styleCheck() {

            if (document.queryCommandState('bold')) {$('#boldBtnCurrent').addClass('active');} else {$('#boldBtnCurrent').removeClass('active');}
            if (document.queryCommandState('italic')) {$('#italicBtnCurrent').addClass('active');} else {$('#italicBtnCurrent').removeClass('active');}
            if (document.queryCommandState('underline')) {$('#underlineBtnCurrent').addClass('active');} else {$('#underlineBtnCurrent').removeClass('active');}
            if (document.queryCommandState('strikeThrough')) {$('#strikeBtnCurrent').addClass('active');} else {$('#strikeBtnCurrent').removeClass('active');}
            
            if (document.queryCommandState('insertUnorderedList')) {$('#ulBtnCurrent').addClass('active');} else {$('#ulBtnCurrent').removeClass('active');}
            if (document.queryCommandState('insertOrderedList')) {$('#olBtnCurrent').addClass('active');} else {$('#olBtnCurrent').removeClass('active');}

        }

        /* formatting check events */
        $('.current-note-content').keyup(function() {

            styleCheck();

        });

        $('.current-note-content').click(function() {

            styleCheck();

        });

        /* formatting */
        $('#boldBtnCurrent').click(function() {

            $('.current-note-content').focus();
            document.execCommand('bold');
            $('.current-note-content').focus();

            styleCheck();

        });

        $('#italicBtnCurrent').click(function() {

            $('.current-note-content').focus();
            document.execCommand('italic');
            $('.current-note-content').focus();

            styleCheck();

        });

        $('#underlineBtnCurrent').click(function() {
            
            $('.current-note-content').focus();
            document.execCommand('underline');
            $('.current-note-content').focus();

            styleCheck();

        });

        $('#strikeBtnCurrent').click(function() {
            
            $('.current-note-content').focus();
            document.execCommand('strikeThrough');
            $('.current-note-content').focus();

            styleCheck();

        });

        $('#ulBtnCurrent').click(function() {

            $('.current-note-content').focus();
            document.execCommand('insertUnorderedList');
            $('.current-note-content').focus();

            styleCheck();

        });

        $('#olBtnCurrent').click(function() {

            $('.current-note-content').focus();
            document.execCommand('insertOrderedList');
            $('.current-note-content').focus();
            
            styleCheck();

        });

        /* photo upload */
        $('#photoBtnCurrent').click(function() {

            $(this).addClass('active');
            setTimeout(function() {$('#photoBtnCurrent').removeClass('active')}, 200);

            $('#currentNotePhotoInput').click();

        });

        $('#currentNotePhotoInput').on('change', function() {

            $('#currentNotePhotoSubmit').click();

        });

        /* Remove style from pasted text */
        document.getElementsByClassName('current-note-content')[0].addEventListener('paste', function(e) {

            e.preventDefault();
            var text = e.clipboardData. getData("text/plain");
            document.execCommand("insertHTML", false, text);

        });

    </script>

    <!-- Trash -->

    <script>

        $('body').on('click', '#emptyTrashBtn', function() {

            $(this).addClass('active');

            $('.empty-trash').animate({

                'opacity': 0,

            }, 250);

            $('.note-section').children('.note').each(function() {
                    
                $(this).animate({

                    'opacity': 0,

                }, 250);

            });

            setTimeout(function() {

                $('.note-section').children('.note').each(function() {
                    
                    $(this).remove();

                });
                
                $('#emptyTrashBtn').remove();
                
                $('.empty-trash').children('.info').text('Корзина пуста!');
                $('.empty-trash').animate({

                    'opacity': 1,

                }, 250);

            }, 250)

            $.ajax({

                type: 'POST',

                url: "{% url 'app:empty-trash' %}",

                data: {

                    'csrfmiddlewaretoken': '{{ csrf_token }}',

                }

            });

        });

    </script>

</html>